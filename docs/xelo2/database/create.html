<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.8.1" />
<title>xelo2.database.create API documentation</title>
<meta name="description" content="Subtables should have a field called &#34;when&#34; and be called &#34;parents_EXTRA&#34;" />
<link href='https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css' rel='stylesheet'>
<link href='https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/8.0.0/sanitize.min.css' rel='stylesheet'>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
<style>.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>xelo2.database.create</code></h1>
</header>
<section id="section-intro">
<p>Subtables should have a field called "when" and be called "parents_EXTRA"</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;Subtables should have a field called &#34;when&#34; and be called &#34;parents_EXTRA&#34;
&#34;&#34;&#34;
from logging import getLogger
from pathlib import Path
from textwrap import dedent

from PyQt5.QtSql import (
    QSqlDatabase,
    QSqlQuery,
    )

from .tables import TABLES
from .queries import prepare_query_with_column_names, sql_in


lg = getLogger(__name__)
CONNECTION_NAME = &#39;xelo2_database&#39;


def open_database(db_type, db_name, username=None, password=None, connectionName=CONNECTION_NAME):
    &#34;&#34;&#34;Open the default database using Qt framework

    Parameters
    ----------
    db_type : str
        driver to use (QSQLITE or QMYSQL)
    db_name : str
        path to database (QSQLITE) or database name (QMYSQL)
    username : str
        user name to open database
    password : str
        password to open database

    Returns
    -------
    QSqlDatabase
        default database
    &#34;&#34;&#34;
    assert db_type in (&#39;QSQLITE&#39;, &#39;QMYSQL&#39;)
    db = QSqlDatabase.addDatabase(db_type, connectionName)
    assert db.isValid()

    if db_type == &#39;QSQLITE&#39;:
        db_name = Path(db_name).expanduser().resolve()
    else:
        db.setHostName(&#39;127.0.0.1&#39;)
        db.setUserName(username)
        if password is not None:
            db.setPassword(password)

    db.setDatabaseName(str(db_name))
    db.open()

    if db_type == &#39;QSQLITE&#39;:
        assert QSqlQuery(db).exec(&#39;PRAGMA foreign_keys = ON;&#39;)
        assert QSqlQuery(db).exec(&#39;PRAGMA encoding=&#34;UTF-8&#34;;&#39;)

    if not db.isOpen():
        raise ValueError(&#39;Could not open database&#39;)

    return db


def close_database(db):
    db.close()
    QSqlDatabase.removeDatabase(db.connectionName())


def create_database(db_type, db_name, username=None, password=None):
    &#34;&#34;&#34;Create a default database using Qt framework

    Parameters
    ----------
    db_type : str
        driver to use (QSQLITE or QMYSQL)
    db_name : str
        path to database (QSQLITE) or database name (QMYSQL)
    username : str
        user name to open database
    password : str
        password to open database

    Returns
    -------
    QSqlDatabase
        default database
    &#34;&#34;&#34;
    assert db_type in (&#39;QSQLITE&#39;, &#39;QMYSQL&#39;)
    db = QSqlDatabase.addDatabase(db_type, CONNECTION_NAME)
    assert db.isValid()

    if db_type == &#39;QSQLITE&#39;:
        db_name = Path(db_name).expanduser().resolve()
        if db_name.exists():
            db_name.unlink()

    else:

        _drop_create_mysql(db_name, username, password)
        db.setHostName(&#39;127.0.0.1&#39;)
        db.setUserName(username)
        if password is not None:
            db.setPassword(password)

    db.setDatabaseName(str(db_name))
    db.open()

    if db_type == &#39;QSQLITE&#39;:
        assert QSqlQuery(db).exec(&#39;PRAGMA foreign_keys = ON;&#39;)
        assert QSqlQuery(db).exec(&#39;PRAGMA encoding=&#34;UTF-8&#34;;&#39;)

    db.transaction()

    for table_name, v in TABLES.items():
        create_statement_table(db, table_name, v)

    add_experimenters(db, TABLES[&#39;experimenters&#39;])

    add_triggers_to_check_values(db, TABLES)
    add_triggers_to_add_id(db, TABLES)
    add_triggers_to_delete_orphan_files(db, TABLES)

    add_views(db)

    db.commit()
    close_database(db)


def create_statement_table(db, table_name, v):
    &#34;&#34;&#34;
    Prepare and write CREATE statements for each table

    Parameters
    ----------
    db : instance of QSqlDatabase
        default database
    table_name : str
        name of the table
    v : dict
        where each key is a column of the table
    &#34;&#34;&#34;
    foreign_keys = []
    constraints = []
    cmd = []

    for col_name, col_info in v.items():

        if col_name == &#39;when&#39;:
            continue

        elif col_name == &#39;id&#39;:
            if db.driverName() == &#39;QSQLITE&#39;:
                auto = &#39;AUTOINCREMENT&#39;
            else:
                auto = &#39;AUTO_INCREMENT&#39;
            cmd.append(f&#39;id INTEGER PRIMARY KEY {auto}&#39;)

        elif col_name.endswith(&#39;_id&#39;) or &#34;foreign_key&#34; in col_info:
            if col_info is not None and &#39;foreign_key&#39; in col_info:
                foreign_key = col_info[&#39;foreign_key&#39;]
            else:
                foreign_key = col_name

            if &#39;when&#39; in v and col_name == list(v)[0]:  # if sub-table, then make sure that the first index is unique (but not the other ones)
                cmd.append(f&#39;{col_name} INTEGER UNIQUE&#39;)
            else:
                cmd.append(f&#39;{col_name} INTEGER&#39;)

            ref_table = &#39;_&#39;.join(foreign_key.split(&#39;_&#39;)[:-1])
            foreign_keys.append(f&#39;FOREIGN KEY ({col_name}) REFERENCES {ref_table}s (id) ON DELETE CASCADE&#39;)

        else:
            sql_col = f&#39;{col_name} {col_info[&#34;type&#34;]}&#39;
            if &#39;default&#39; in col_info:
                sql_col += f&#39; DEFAULT {col_info[&#34;default&#34;]}&#39;
            cmd.append(sql_col)

    if len(v) == 2 and list(v)[0].endswith(&#39;_id&#39;) and list(v)[1].endswith(&#39;_id&#39;):
        constraints.append(f&#39;CONSTRAINT {table_name}_unique UNIQUE ({list(v)[0]}, {list(v)[1]})&#39;)

    cmd.extend(foreign_keys)
    cmd.extend(constraints)

    sql_cmd = f&#39;CREATE TABLE {table_name} (\n &#39; + &#39;,\n &#39;.join(cmd) + &#39;\n)&#39;

    query = QSqlQuery(db)
    if not query.exec(sql_cmd):
        lg.debug(sql_cmd)
        lg.warning(query.lastError().text())


def add_triggers_to_check_values(db, TABLES):
    &#34;&#34;&#34;Add triggers to check if values are allowed, based on table of allowed_values
    This method is more flexible than using CONSTRAINT because we can easily
    add new values by changing the allowed_values table instead of ALTERing the
    table

    Parameters
    ----------
    db : instance of QSqlDatabase
        default database
    TABLES : dict
        description of tables
    &#34;&#34;&#34;
    sql_cmd = &#39;CREATE TABLE allowed_values ( table_name TEXT NOT NULL, column_name TEXT NOT NULL, allowed_value TEXT NOT NULL)&#39;
    query = QSqlQuery(db)
    if not query.exec(sql_cmd):
        lg.debug(sql_cmd)
        lg.warning(query.lastError().text())

    query = QSqlQuery(db)
    query.prepare(&#34;&#34;&#34;\
        INSERT INTO `allowed_values` (`table_name`, `column_name`, `allowed_value`)
        VALUES (:table_name, :column_name, :allowed_value)&#34;&#34;&#34;)

    for table_name, table_info in TABLES.items():
        if table_name == &#39;experimenters&#39;:
            continue  # experimenters go into a separate table
        query.bindValue(&#34;:table_name&#34;, table_name)

        for col_name, col_info in table_info.items():
            query.bindValue(&#34;:column_name&#34;, col_name)

            if col_info is not None and &#39;values&#39; in col_info:
                for value in col_info[&#39;values&#39;]:
                    query.bindValue(&#34;:allowed_value&#34;, value)
                    if not query.exec():
                        lg.debug(f&#39;{table_name} / {col_name} : &#34;{value}&#34;&#39;)
                        lg.warning(query.lastError().text())

                for statement in (&#39;INSERT&#39;, &#39;UPDATE&#39;):  # sql cannot handle both in the same trigger statement
                    if db.driverName() == &#39;QSQLITE&#39;:
                        sql_cmd = dedent(f&#34;&#34;&#34;\
                            CREATE TRIGGER validate_{col_name}_before_{statement.lower()}_to_{table_name}
                              BEFORE {statement} ON {table_name}
                            BEGIN
                              SELECT
                                CASE
                                  WHEN NEW.{col_name} NOT IN (
                                    SELECT allowed_value FROM allowed_values
                                    WHERE table_name == &#39;{table_name}&#39;
                                    AND column_name == &#39;{col_name}&#39;)
                                THEN
                                  RAISE (ABORT, &#39;Invalid {col_name} for {table_name}&#39;)
                                END;
                            END;&#34;&#34;&#34;)
                    else:
                        sql_cmd = dedent(f&#34;&#34;&#34;\
                            CREATE TRIGGER validate_{col_name}_before_{statement.lower()}_to_{table_name}
                              BEFORE {statement} ON {table_name}
                              FOR EACH ROW
                            BEGIN
                              IF NEW.{col_name} NOT IN (
                                SELECT allowed_value FROM allowed_values
                                WHERE table_name = &#39;{table_name}&#39;
                                AND column_name = &#39;{col_name}&#39;)
                              THEN
                                SIGNAL SQLSTATE &#39;2201R&#39; SET MESSAGE_TEXT = &#39;Entered value in column {col_name} is not allowed in table {table_name}&#39;;
                              END IF;
                            END;&#34;&#34;&#34;)

                    trigger_query = QSqlQuery(db)
                    if not trigger_query.exec(sql_cmd):
                        lg.debug(sql_cmd)
                        lg.warning(trigger_query.lastError().text())


def add_triggers_to_add_id(db, TABLES):
    &#34;&#34;&#34;These triggers add the ID of the main table to the subtables

    Parameters
    ----------
    db : instance of QSqlDatabase
        default database
    TABLES : dict
        description of tables

    TODO
    ----
    I could not think of a nice way to prune the rows when updating the name
    of the session. So, if you have an &#34;MRI&#34; session and you change that
    session to &#34;IEMU&#34;, then the sessions_mri will still contain info related to
    that session. Maybe it&#39;s not bad to keep this info but it&#39;s also not useful
    &#34;&#34;&#34;
    for table_name, table_info in TABLES.items():
        if &#39;when&#39; in table_info:
            parent_table = table_name.split(&#39;_&#39;)[0]
            WHEN = table_info[&#39;when&#39;]

            if db.driverName() == &#39;QSQLITE&#39;:
                sql_cmd = dedent(f&#34;&#34;&#34;\
                    CREATE TRIGGER add_id_to_subtable_{table_name}
                    AFTER INSERT ON {parent_table}
                    WHEN
                      NEW.{WHEN[&#39;parameter&#39;]} {sql_in(WHEN[&#39;value&#39;])}
                    BEGIN
                      INSERT INTO {table_name} ({parent_table[:-1]}_id) VALUES (NEW.id) ;
                    END;&#34;&#34;&#34;)
            else:
                sql_cmd = dedent(f&#34;&#34;&#34;\
                    CREATE TRIGGER add_id_to_subtable_{table_name}
                      AFTER INSERT ON {parent_table}
                      FOR EACH ROW
                    BEGIN
                      IF NEW.{WHEN[&#39;parameter&#39;]} {sql_in(WHEN[&#39;value&#39;])}
                      THEN
                        INSERT INTO {table_name} ({parent_table[:-1]}_id) VALUES (NEW.id) ;
                      END IF;
                    END;&#34;&#34;&#34;)

            query = QSqlQuery(db)
            if not query.exec(sql_cmd):
                lg.debug(sql_cmd)
                lg.warning(query.lastError().text())

            if db.driverName() == &#39;QSQLITE&#39;:
                parent_id = f&#39;{parent_table[:-1]}_id&#39;
                sql_cmd = dedent(f&#34;&#34;&#34;\
                    CREATE TRIGGER replace_id_to_subtable_{table_name}
                    BEFORE UPDATE ON {parent_table}
                    WHEN
                      NEW.{WHEN[&#39;parameter&#39;]} &lt;&gt; OLD.{WHEN[&#39;parameter&#39;]} AND
                      NEW.{WHEN[&#39;parameter&#39;]} {sql_in(WHEN[&#39;value&#39;])} AND
                      NEW.id NOT IN (SELECT {parent_id} FROM {table_name})
                    BEGIN
                      INSERT INTO {table_name} ({parent_id}) VALUES (NEW.id) ;
                    END;&#34;&#34;&#34;)

            else:
                sql_cmd = dedent(f&#34;&#34;&#34;\
                    CREATE TRIGGER replace_id_to_subtable_{table_name}
                      BEFORE UPDATE ON {parent_table}
                      FOR EACH ROW
                    BEGIN
                      IF NEW.{WHEN[&#39;parameter&#39;]} &lt;&gt; OLD.{WHEN[&#39;parameter&#39;]} AND
                        NEW.{WHEN[&#39;parameter&#39;]} {sql_in(WHEN[&#39;value&#39;])}
                      THEN
                        INSERT INTO {table_name} ({parent_table[:-1]}_id) VALUES (NEW.id) ;
                      END IF;
                    END;&#34;&#34;&#34;)

            query = QSqlQuery(db)
            if not query.exec(sql_cmd):
                lg.debug(sql_cmd)
                lg.warning(query.lastError().text())


def add_experimenters(db, table_experimenters):
    &#34;&#34;&#34;Add table with experimenters. We use a separate table so that we can
    point to them by index
    &#34;&#34;&#34;
    for experimenter in table_experimenters[&#39;name&#39;][&#39;values&#39;]:
        sql_cmd = dedent(f&#34;&#34;&#34;\
            INSERT INTO experimenters (`name`)
            VALUES (&#39;{experimenter}&#39;)&#34;&#34;&#34;)
        query = QSqlQuery(db)
        if not query.exec(sql_cmd):
            lg.debug(sql_cmd)
            lg.warning(query.lastError().text())


def add_views(db):
    &#34;&#34;&#34;Create a general view with some information that might be useful&#34;&#34;&#34;
    query_str = prepare_query_with_column_names((&#39;subjects&#39;, &#39;sessions&#39;, &#39;runs&#39;))
    sql_cmd = &#39;CREATE VIEW all_recordings AS \n&#39; + query_str
    query = QSqlQuery(db)
    if not query.exec(sql_cmd):
        lg.debug(sql_cmd)
        lg.warning(query.lastError().text())


def add_triggers_to_delete_orphan_files(db, TABLES):
    triggers = trigger_for_orphan_files(TABLES, db.driverName())

    for sql_cmd in triggers:
        query = QSqlQuery(db)
        if not query.exec(sql_cmd):
            lg.debug(sql_cmd)
            lg.warning(query.lastError().text())


def trigger_for_orphan_files(TABLES, db_type):
    table_files = []
    for table in TABLES:
        if table.endswith(&#39;_files&#39;):
            table_files.append(table)

    search = []
    for table in table_files:
        search.append(f&#39;NOT EXISTS(SELECT file_id FROM {table} WHERE file_id = OLD.file_id)&#39;)
    search_tables = &#39; AND &#39;.join(search)

    for table in table_files:
        if db_type == &#39;QSQLITE&#39;:
            sql_cmd = dedent(f&#34;&#34;&#34;\
                CREATE TRIGGER delete_file_if_no_links_in_{table}
                AFTER DELETE ON {table}
                WHEN
                  {search_tables}
                BEGIN
                  DELETE FROM files WHERE id = OLD.file_id ;
                END&#34;&#34;&#34;)
        else:
            sql_cmd = dedent(f&#34;&#34;&#34;\
                CREATE TRIGGER delete_file_if_no_links_in_{table}
                  AFTER DELETE ON {table}
                  FOR EACH ROW
                BEGIN
                  IF {search_tables}
                  THEN
                    DELETE FROM files WHERE id = OLD.file_id ;
                  END IF ;
                END&#34;&#34;&#34;)
        yield sql_cmd


def _drop_create_mysql(db_name, username, password):
    db = QSqlDatabase.addDatabase(&#39;QMYSQL&#39;, &#39;information_schema&#39;)

    db.setHostName(&#39;127.0.0.1&#39;)
    db.setUserName(username)
    db.setPassword(password)
    db.setDatabaseName(&#39;information_schema&#39;)
    db.open()

    q = QSqlQuery(db)
    assert q.exec(f&#39;DROP DATABASE IF EXISTS {db_name};&#39;)
    assert q.exec(f&#39;CREATE DATABASE {db_name};&#39;)
    db.close()</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="xelo2.database.create.add_experimenters"><code class="name flex">
<span>def <span class="ident">add_experimenters</span></span>(<span>db, table_experimenters)</span>
</code></dt>
<dd>
<div class="desc"><p>Add table with experimenters. We use a separate table so that we can
point to them by index</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_experimenters(db, table_experimenters):
    &#34;&#34;&#34;Add table with experimenters. We use a separate table so that we can
    point to them by index
    &#34;&#34;&#34;
    for experimenter in table_experimenters[&#39;name&#39;][&#39;values&#39;]:
        sql_cmd = dedent(f&#34;&#34;&#34;\
            INSERT INTO experimenters (`name`)
            VALUES (&#39;{experimenter}&#39;)&#34;&#34;&#34;)
        query = QSqlQuery(db)
        if not query.exec(sql_cmd):
            lg.debug(sql_cmd)
            lg.warning(query.lastError().text())</code></pre>
</details>
</dd>
<dt id="xelo2.database.create.add_triggers_to_add_id"><code class="name flex">
<span>def <span class="ident">add_triggers_to_add_id</span></span>(<span>db, TABLES)</span>
</code></dt>
<dd>
<div class="desc"><p>These triggers add the ID of the main table to the subtables</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>db</code></strong> :&ensp;<code>instance</code> of <code>QSqlDatabase</code></dt>
<dd>default database</dd>
<dt><strong><code>TABLES</code></strong> :&ensp;<code>dict</code></dt>
<dd>description of tables</dd>
</dl>
<h2 id="todo">Todo</h2>
<p>I could not think of a nice way to prune the rows when updating the name
of the session. So, if you have an "MRI" session and you change that
session to "IEMU", then the sessions_mri will still contain info related to
that session. Maybe it's not bad to keep this info but it's also not useful</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_triggers_to_add_id(db, TABLES):
    &#34;&#34;&#34;These triggers add the ID of the main table to the subtables

    Parameters
    ----------
    db : instance of QSqlDatabase
        default database
    TABLES : dict
        description of tables

    TODO
    ----
    I could not think of a nice way to prune the rows when updating the name
    of the session. So, if you have an &#34;MRI&#34; session and you change that
    session to &#34;IEMU&#34;, then the sessions_mri will still contain info related to
    that session. Maybe it&#39;s not bad to keep this info but it&#39;s also not useful
    &#34;&#34;&#34;
    for table_name, table_info in TABLES.items():
        if &#39;when&#39; in table_info:
            parent_table = table_name.split(&#39;_&#39;)[0]
            WHEN = table_info[&#39;when&#39;]

            if db.driverName() == &#39;QSQLITE&#39;:
                sql_cmd = dedent(f&#34;&#34;&#34;\
                    CREATE TRIGGER add_id_to_subtable_{table_name}
                    AFTER INSERT ON {parent_table}
                    WHEN
                      NEW.{WHEN[&#39;parameter&#39;]} {sql_in(WHEN[&#39;value&#39;])}
                    BEGIN
                      INSERT INTO {table_name} ({parent_table[:-1]}_id) VALUES (NEW.id) ;
                    END;&#34;&#34;&#34;)
            else:
                sql_cmd = dedent(f&#34;&#34;&#34;\
                    CREATE TRIGGER add_id_to_subtable_{table_name}
                      AFTER INSERT ON {parent_table}
                      FOR EACH ROW
                    BEGIN
                      IF NEW.{WHEN[&#39;parameter&#39;]} {sql_in(WHEN[&#39;value&#39;])}
                      THEN
                        INSERT INTO {table_name} ({parent_table[:-1]}_id) VALUES (NEW.id) ;
                      END IF;
                    END;&#34;&#34;&#34;)

            query = QSqlQuery(db)
            if not query.exec(sql_cmd):
                lg.debug(sql_cmd)
                lg.warning(query.lastError().text())

            if db.driverName() == &#39;QSQLITE&#39;:
                parent_id = f&#39;{parent_table[:-1]}_id&#39;
                sql_cmd = dedent(f&#34;&#34;&#34;\
                    CREATE TRIGGER replace_id_to_subtable_{table_name}
                    BEFORE UPDATE ON {parent_table}
                    WHEN
                      NEW.{WHEN[&#39;parameter&#39;]} &lt;&gt; OLD.{WHEN[&#39;parameter&#39;]} AND
                      NEW.{WHEN[&#39;parameter&#39;]} {sql_in(WHEN[&#39;value&#39;])} AND
                      NEW.id NOT IN (SELECT {parent_id} FROM {table_name})
                    BEGIN
                      INSERT INTO {table_name} ({parent_id}) VALUES (NEW.id) ;
                    END;&#34;&#34;&#34;)

            else:
                sql_cmd = dedent(f&#34;&#34;&#34;\
                    CREATE TRIGGER replace_id_to_subtable_{table_name}
                      BEFORE UPDATE ON {parent_table}
                      FOR EACH ROW
                    BEGIN
                      IF NEW.{WHEN[&#39;parameter&#39;]} &lt;&gt; OLD.{WHEN[&#39;parameter&#39;]} AND
                        NEW.{WHEN[&#39;parameter&#39;]} {sql_in(WHEN[&#39;value&#39;])}
                      THEN
                        INSERT INTO {table_name} ({parent_table[:-1]}_id) VALUES (NEW.id) ;
                      END IF;
                    END;&#34;&#34;&#34;)

            query = QSqlQuery(db)
            if not query.exec(sql_cmd):
                lg.debug(sql_cmd)
                lg.warning(query.lastError().text())</code></pre>
</details>
</dd>
<dt id="xelo2.database.create.add_triggers_to_check_values"><code class="name flex">
<span>def <span class="ident">add_triggers_to_check_values</span></span>(<span>db, TABLES)</span>
</code></dt>
<dd>
<div class="desc"><p>Add triggers to check if values are allowed, based on table of allowed_values
This method is more flexible than using CONSTRAINT because we can easily
add new values by changing the allowed_values table instead of ALTERing the
table</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>db</code></strong> :&ensp;<code>instance</code> of <code>QSqlDatabase</code></dt>
<dd>default database</dd>
<dt><strong><code>TABLES</code></strong> :&ensp;<code>dict</code></dt>
<dd>description of tables</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_triggers_to_check_values(db, TABLES):
    &#34;&#34;&#34;Add triggers to check if values are allowed, based on table of allowed_values
    This method is more flexible than using CONSTRAINT because we can easily
    add new values by changing the allowed_values table instead of ALTERing the
    table

    Parameters
    ----------
    db : instance of QSqlDatabase
        default database
    TABLES : dict
        description of tables
    &#34;&#34;&#34;
    sql_cmd = &#39;CREATE TABLE allowed_values ( table_name TEXT NOT NULL, column_name TEXT NOT NULL, allowed_value TEXT NOT NULL)&#39;
    query = QSqlQuery(db)
    if not query.exec(sql_cmd):
        lg.debug(sql_cmd)
        lg.warning(query.lastError().text())

    query = QSqlQuery(db)
    query.prepare(&#34;&#34;&#34;\
        INSERT INTO `allowed_values` (`table_name`, `column_name`, `allowed_value`)
        VALUES (:table_name, :column_name, :allowed_value)&#34;&#34;&#34;)

    for table_name, table_info in TABLES.items():
        if table_name == &#39;experimenters&#39;:
            continue  # experimenters go into a separate table
        query.bindValue(&#34;:table_name&#34;, table_name)

        for col_name, col_info in table_info.items():
            query.bindValue(&#34;:column_name&#34;, col_name)

            if col_info is not None and &#39;values&#39; in col_info:
                for value in col_info[&#39;values&#39;]:
                    query.bindValue(&#34;:allowed_value&#34;, value)
                    if not query.exec():
                        lg.debug(f&#39;{table_name} / {col_name} : &#34;{value}&#34;&#39;)
                        lg.warning(query.lastError().text())

                for statement in (&#39;INSERT&#39;, &#39;UPDATE&#39;):  # sql cannot handle both in the same trigger statement
                    if db.driverName() == &#39;QSQLITE&#39;:
                        sql_cmd = dedent(f&#34;&#34;&#34;\
                            CREATE TRIGGER validate_{col_name}_before_{statement.lower()}_to_{table_name}
                              BEFORE {statement} ON {table_name}
                            BEGIN
                              SELECT
                                CASE
                                  WHEN NEW.{col_name} NOT IN (
                                    SELECT allowed_value FROM allowed_values
                                    WHERE table_name == &#39;{table_name}&#39;
                                    AND column_name == &#39;{col_name}&#39;)
                                THEN
                                  RAISE (ABORT, &#39;Invalid {col_name} for {table_name}&#39;)
                                END;
                            END;&#34;&#34;&#34;)
                    else:
                        sql_cmd = dedent(f&#34;&#34;&#34;\
                            CREATE TRIGGER validate_{col_name}_before_{statement.lower()}_to_{table_name}
                              BEFORE {statement} ON {table_name}
                              FOR EACH ROW
                            BEGIN
                              IF NEW.{col_name} NOT IN (
                                SELECT allowed_value FROM allowed_values
                                WHERE table_name = &#39;{table_name}&#39;
                                AND column_name = &#39;{col_name}&#39;)
                              THEN
                                SIGNAL SQLSTATE &#39;2201R&#39; SET MESSAGE_TEXT = &#39;Entered value in column {col_name} is not allowed in table {table_name}&#39;;
                              END IF;
                            END;&#34;&#34;&#34;)

                    trigger_query = QSqlQuery(db)
                    if not trigger_query.exec(sql_cmd):
                        lg.debug(sql_cmd)
                        lg.warning(trigger_query.lastError().text())</code></pre>
</details>
</dd>
<dt id="xelo2.database.create.add_triggers_to_delete_orphan_files"><code class="name flex">
<span>def <span class="ident">add_triggers_to_delete_orphan_files</span></span>(<span>db, TABLES)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_triggers_to_delete_orphan_files(db, TABLES):
    triggers = trigger_for_orphan_files(TABLES, db.driverName())

    for sql_cmd in triggers:
        query = QSqlQuery(db)
        if not query.exec(sql_cmd):
            lg.debug(sql_cmd)
            lg.warning(query.lastError().text())</code></pre>
</details>
</dd>
<dt id="xelo2.database.create.add_views"><code class="name flex">
<span>def <span class="ident">add_views</span></span>(<span>db)</span>
</code></dt>
<dd>
<div class="desc"><p>Create a general view with some information that might be useful</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_views(db):
    &#34;&#34;&#34;Create a general view with some information that might be useful&#34;&#34;&#34;
    query_str = prepare_query_with_column_names((&#39;subjects&#39;, &#39;sessions&#39;, &#39;runs&#39;))
    sql_cmd = &#39;CREATE VIEW all_recordings AS \n&#39; + query_str
    query = QSqlQuery(db)
    if not query.exec(sql_cmd):
        lg.debug(sql_cmd)
        lg.warning(query.lastError().text())</code></pre>
</details>
</dd>
<dt id="xelo2.database.create.close_database"><code class="name flex">
<span>def <span class="ident">close_database</span></span>(<span>db)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def close_database(db):
    db.close()
    QSqlDatabase.removeDatabase(db.connectionName())</code></pre>
</details>
</dd>
<dt id="xelo2.database.create.create_database"><code class="name flex">
<span>def <span class="ident">create_database</span></span>(<span>db_type, db_name, username=None, password=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Create a default database using Qt framework</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>db_type</code></strong> :&ensp;<code>str</code></dt>
<dd>driver to use (QSQLITE or QMYSQL)</dd>
<dt><strong><code>db_name</code></strong> :&ensp;<code>str</code></dt>
<dd>path to database (QSQLITE) or database name (QMYSQL)</dd>
<dt><strong><code>username</code></strong> :&ensp;<code>str</code></dt>
<dd>user name to open database</dd>
<dt><strong><code>password</code></strong> :&ensp;<code>str</code></dt>
<dd>password to open database</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>QSqlDatabase</code></dt>
<dd>default database</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_database(db_type, db_name, username=None, password=None):
    &#34;&#34;&#34;Create a default database using Qt framework

    Parameters
    ----------
    db_type : str
        driver to use (QSQLITE or QMYSQL)
    db_name : str
        path to database (QSQLITE) or database name (QMYSQL)
    username : str
        user name to open database
    password : str
        password to open database

    Returns
    -------
    QSqlDatabase
        default database
    &#34;&#34;&#34;
    assert db_type in (&#39;QSQLITE&#39;, &#39;QMYSQL&#39;)
    db = QSqlDatabase.addDatabase(db_type, CONNECTION_NAME)
    assert db.isValid()

    if db_type == &#39;QSQLITE&#39;:
        db_name = Path(db_name).expanduser().resolve()
        if db_name.exists():
            db_name.unlink()

    else:

        _drop_create_mysql(db_name, username, password)
        db.setHostName(&#39;127.0.0.1&#39;)
        db.setUserName(username)
        if password is not None:
            db.setPassword(password)

    db.setDatabaseName(str(db_name))
    db.open()

    if db_type == &#39;QSQLITE&#39;:
        assert QSqlQuery(db).exec(&#39;PRAGMA foreign_keys = ON;&#39;)
        assert QSqlQuery(db).exec(&#39;PRAGMA encoding=&#34;UTF-8&#34;;&#39;)

    db.transaction()

    for table_name, v in TABLES.items():
        create_statement_table(db, table_name, v)

    add_experimenters(db, TABLES[&#39;experimenters&#39;])

    add_triggers_to_check_values(db, TABLES)
    add_triggers_to_add_id(db, TABLES)
    add_triggers_to_delete_orphan_files(db, TABLES)

    add_views(db)

    db.commit()
    close_database(db)</code></pre>
</details>
</dd>
<dt id="xelo2.database.create.create_statement_table"><code class="name flex">
<span>def <span class="ident">create_statement_table</span></span>(<span>db, table_name, v)</span>
</code></dt>
<dd>
<div class="desc"><p>Prepare and write CREATE statements for each table</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>db</code></strong> :&ensp;<code>instance</code> of <code>QSqlDatabase</code></dt>
<dd>default database</dd>
<dt><strong><code>table_name</code></strong> :&ensp;<code>str</code></dt>
<dd>name of the table</dd>
<dt><strong><code>v</code></strong> :&ensp;<code>dict</code></dt>
<dd>where each key is a column of the table</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_statement_table(db, table_name, v):
    &#34;&#34;&#34;
    Prepare and write CREATE statements for each table

    Parameters
    ----------
    db : instance of QSqlDatabase
        default database
    table_name : str
        name of the table
    v : dict
        where each key is a column of the table
    &#34;&#34;&#34;
    foreign_keys = []
    constraints = []
    cmd = []

    for col_name, col_info in v.items():

        if col_name == &#39;when&#39;:
            continue

        elif col_name == &#39;id&#39;:
            if db.driverName() == &#39;QSQLITE&#39;:
                auto = &#39;AUTOINCREMENT&#39;
            else:
                auto = &#39;AUTO_INCREMENT&#39;
            cmd.append(f&#39;id INTEGER PRIMARY KEY {auto}&#39;)

        elif col_name.endswith(&#39;_id&#39;) or &#34;foreign_key&#34; in col_info:
            if col_info is not None and &#39;foreign_key&#39; in col_info:
                foreign_key = col_info[&#39;foreign_key&#39;]
            else:
                foreign_key = col_name

            if &#39;when&#39; in v and col_name == list(v)[0]:  # if sub-table, then make sure that the first index is unique (but not the other ones)
                cmd.append(f&#39;{col_name} INTEGER UNIQUE&#39;)
            else:
                cmd.append(f&#39;{col_name} INTEGER&#39;)

            ref_table = &#39;_&#39;.join(foreign_key.split(&#39;_&#39;)[:-1])
            foreign_keys.append(f&#39;FOREIGN KEY ({col_name}) REFERENCES {ref_table}s (id) ON DELETE CASCADE&#39;)

        else:
            sql_col = f&#39;{col_name} {col_info[&#34;type&#34;]}&#39;
            if &#39;default&#39; in col_info:
                sql_col += f&#39; DEFAULT {col_info[&#34;default&#34;]}&#39;
            cmd.append(sql_col)

    if len(v) == 2 and list(v)[0].endswith(&#39;_id&#39;) and list(v)[1].endswith(&#39;_id&#39;):
        constraints.append(f&#39;CONSTRAINT {table_name}_unique UNIQUE ({list(v)[0]}, {list(v)[1]})&#39;)

    cmd.extend(foreign_keys)
    cmd.extend(constraints)

    sql_cmd = f&#39;CREATE TABLE {table_name} (\n &#39; + &#39;,\n &#39;.join(cmd) + &#39;\n)&#39;

    query = QSqlQuery(db)
    if not query.exec(sql_cmd):
        lg.debug(sql_cmd)
        lg.warning(query.lastError().text())</code></pre>
</details>
</dd>
<dt id="xelo2.database.create.open_database"><code class="name flex">
<span>def <span class="ident">open_database</span></span>(<span>db_type, db_name, username=None, password=None, connectionName='xelo2_database')</span>
</code></dt>
<dd>
<div class="desc"><p>Open the default database using Qt framework</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>db_type</code></strong> :&ensp;<code>str</code></dt>
<dd>driver to use (QSQLITE or QMYSQL)</dd>
<dt><strong><code>db_name</code></strong> :&ensp;<code>str</code></dt>
<dd>path to database (QSQLITE) or database name (QMYSQL)</dd>
<dt><strong><code>username</code></strong> :&ensp;<code>str</code></dt>
<dd>user name to open database</dd>
<dt><strong><code>password</code></strong> :&ensp;<code>str</code></dt>
<dd>password to open database</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>QSqlDatabase</code></dt>
<dd>default database</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def open_database(db_type, db_name, username=None, password=None, connectionName=CONNECTION_NAME):
    &#34;&#34;&#34;Open the default database using Qt framework

    Parameters
    ----------
    db_type : str
        driver to use (QSQLITE or QMYSQL)
    db_name : str
        path to database (QSQLITE) or database name (QMYSQL)
    username : str
        user name to open database
    password : str
        password to open database

    Returns
    -------
    QSqlDatabase
        default database
    &#34;&#34;&#34;
    assert db_type in (&#39;QSQLITE&#39;, &#39;QMYSQL&#39;)
    db = QSqlDatabase.addDatabase(db_type, connectionName)
    assert db.isValid()

    if db_type == &#39;QSQLITE&#39;:
        db_name = Path(db_name).expanduser().resolve()
    else:
        db.setHostName(&#39;127.0.0.1&#39;)
        db.setUserName(username)
        if password is not None:
            db.setPassword(password)

    db.setDatabaseName(str(db_name))
    db.open()

    if db_type == &#39;QSQLITE&#39;:
        assert QSqlQuery(db).exec(&#39;PRAGMA foreign_keys = ON;&#39;)
        assert QSqlQuery(db).exec(&#39;PRAGMA encoding=&#34;UTF-8&#34;;&#39;)

    if not db.isOpen():
        raise ValueError(&#39;Could not open database&#39;)

    return db</code></pre>
</details>
</dd>
<dt id="xelo2.database.create.trigger_for_orphan_files"><code class="name flex">
<span>def <span class="ident">trigger_for_orphan_files</span></span>(<span>TABLES, db_type)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def trigger_for_orphan_files(TABLES, db_type):
    table_files = []
    for table in TABLES:
        if table.endswith(&#39;_files&#39;):
            table_files.append(table)

    search = []
    for table in table_files:
        search.append(f&#39;NOT EXISTS(SELECT file_id FROM {table} WHERE file_id = OLD.file_id)&#39;)
    search_tables = &#39; AND &#39;.join(search)

    for table in table_files:
        if db_type == &#39;QSQLITE&#39;:
            sql_cmd = dedent(f&#34;&#34;&#34;\
                CREATE TRIGGER delete_file_if_no_links_in_{table}
                AFTER DELETE ON {table}
                WHEN
                  {search_tables}
                BEGIN
                  DELETE FROM files WHERE id = OLD.file_id ;
                END&#34;&#34;&#34;)
        else:
            sql_cmd = dedent(f&#34;&#34;&#34;\
                CREATE TRIGGER delete_file_if_no_links_in_{table}
                  AFTER DELETE ON {table}
                  FOR EACH ROW
                BEGIN
                  IF {search_tables}
                  THEN
                    DELETE FROM files WHERE id = OLD.file_id ;
                  END IF ;
                END&#34;&#34;&#34;)
        yield sql_cmd</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="xelo2.database" href="index.html">xelo2.database</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="xelo2.database.create.add_experimenters" href="#xelo2.database.create.add_experimenters">add_experimenters</a></code></li>
<li><code><a title="xelo2.database.create.add_triggers_to_add_id" href="#xelo2.database.create.add_triggers_to_add_id">add_triggers_to_add_id</a></code></li>
<li><code><a title="xelo2.database.create.add_triggers_to_check_values" href="#xelo2.database.create.add_triggers_to_check_values">add_triggers_to_check_values</a></code></li>
<li><code><a title="xelo2.database.create.add_triggers_to_delete_orphan_files" href="#xelo2.database.create.add_triggers_to_delete_orphan_files">add_triggers_to_delete_orphan_files</a></code></li>
<li><code><a title="xelo2.database.create.add_views" href="#xelo2.database.create.add_views">add_views</a></code></li>
<li><code><a title="xelo2.database.create.close_database" href="#xelo2.database.create.close_database">close_database</a></code></li>
<li><code><a title="xelo2.database.create.create_database" href="#xelo2.database.create.create_database">create_database</a></code></li>
<li><code><a title="xelo2.database.create.create_statement_table" href="#xelo2.database.create.create_statement_table">create_statement_table</a></code></li>
<li><code><a title="xelo2.database.create.open_database" href="#xelo2.database.create.open_database">open_database</a></code></li>
<li><code><a title="xelo2.database.create.trigger_for_orphan_files" href="#xelo2.database.create.trigger_for_orphan_files">trigger_for_orphan_files</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.8.1</a>.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>